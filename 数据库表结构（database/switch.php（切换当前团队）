<?php
require_once '../db.php';
$pdo = getPDO();

$data = json_decode(file_get_contents('php://input'), true);
$openid = $data['openid'] ?? '';
$team_id = $data['team_id'] ?? 0;

if (empty($openid) || $team_id <= 0) {
    echo json_encode(['code' => 400, 'msg' => '参数错误']);
    exit;
}

// 验证是否属于该团队
$stmt = $pdo->prepare("SELECT role FROM team_members WHERE team_id = ? AND user_openid = ?");
$stmt->execute([$team_id, $openid]);
$member = $stmt->fetch();

if (!$member) {
    echo json_encode(['code' => 403, 'msg' => '您未加入该团队']);
    exit;
}

// 更新当前团队
$stmt = $pdo->prepare("UPDATE users SET current_team_id = ? WHERE openid = ?");
$stmt->execute([$team_id, $openid]);

echo json_encode([
    'code' => 0,
    'msg' => '切换成功',
    'data' => ['team_id' => $team_id, 'role' => $member['role']]
]);
?>
