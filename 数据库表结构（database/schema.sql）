CREATE DATABASE IF NOT EXISTS ktv_management CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

USE ktv_management;

CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    openid VARCHAR(128) UNIQUE NOT NULL,
    nickname VARCHAR(100),
    current_team_id INT DEFAULT NULL,
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE memberships (
    id INT AUTO_INCREMENT PRIMARY KEY,
    openid VARCHAR(128) NOT NULL,
    status ENUM('active', 'inactive') DEFAULT 'inactive',
    recharge_amount DECIMAL(10,2) DEFAULT 0.00,
    expire_date DATETIME,
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uniq_openid (openid)
);

CREATE TABLE teams (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) NOT NULL UNIQUE,
    description TEXT,
    creator_openid VARCHAR(128) NOT NULL,
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE team_members (
    team_id INT NOT NULL,
    user_openid VARCHAR(128) NOT NULL,
    role ENUM('admin', 'manager', 'assistant', 'member') DEFAULT 'member',
    join_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (team_id, user_openid),
    FOREIGN KEY (team_id) REFERENCES teams(id) ON DELETE CASCADE,
    FOREIGN KEY (user_openid) REFERENCES users(openid) ON DELETE CASCADE
);
